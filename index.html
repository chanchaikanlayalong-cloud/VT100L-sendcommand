<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Traccar Command Console</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #eef1f6;
      color: #333;
      padding: 30px;
    }
    .container {
      max-width: 950px;
      margin: auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 30px 40px;
    }
    h2, h3 {
      text-align: center;
      color: #007bff;
    }
    input, select, textarea, button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    textarea { height: 100px; resize: vertical; }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover { background: #0056b3; }
    .mode-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .mode-buttons button {
      flex: 1;
      background: #f1f1f1;
      color: #333;
      border: 1px solid #ccc;
    }
    .mode-buttons button.active {
      background: #007bff;
      color: white;
      border: none;
    }
    .hidden { display: none; }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    table.quickcmd-table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.95em;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 20px;
    }
    .quickcmd-table th, .quickcmd-table td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: left;
      vertical-align: middle;
    }
    .quickcmd-table th {
      background: #007bff;
      color: white;
      text-align: center;
    }
    .quickcmd-table tr:nth-child(even) { background: #f8f9fa; }

    .cmd-input {
      width: 100%;
      max-width: 350px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-family: monospace;
      font-size: 0.9em;
      background: #fff;
    }

    .quickcmd-table button {
      width: 110px;
      padding: 6px 10px;
      background: #28a745;
      border-radius: 6px;
      border: none;
      color: white;
      font-size: 0.9em;
      transition: 0.2s;
    }
    .quickcmd-table button:hover { background: #218838; }

    .quickcmd-table th:nth-child(1) { width: 40%; }
    .quickcmd-table th:nth-child(2) { width: 45%; }
    .quickcmd-table th:nth-child(3) { width: 15%; text-align:center; }
    .quickcmd-table td:nth-child(3) { text-align:center; }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå */
    table#resultTable {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.9em;
      margin-top: 15px;
    }
    #resultTable th, #resultTable td {
      border: 1px solid #ddd;
      padding: 8px;
      white-space: pre-wrap;
      word-break: break-word;
      vertical-align: top;
    }
    #resultTable th {
      background: #007bff;
      color: white;
    }

    tr:nth-child(even) { background: #f8f9fa; }
    .ok { color: green; }
    .fail { color: red; }

    .summary {
      background: #f8f9fa;
      margin-top: 15px;
      padding: 12px;
      border-left: 5px solid #007bff;
      border-radius: 6px;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á buzzer */
    .quickcmd-table.buzzer {
      background: #fffbe6;
      border: 2px solid #ffcc00;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üì° Traccar Multi Command Console</h2>

    <div class="mode-buttons">
      <button id="btnManual" class="active" onclick="setMode('manual')">üìù ‡∏Å‡∏£‡∏≠‡∏Å IMEI ‡πÄ‡∏≠‡∏á</button>
      <button id="btnCSV" onclick="setMode('csv')">üìÅ ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå CSV</button>
    </div>

    <div id="manualMode">
      <label>IMEI ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ , ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)</label>
      <textarea id="manualIMEIs" placeholder="862771075372493, 862771075372494"></textarea>
    </div>

    <div id="csvMode" class="hidden">
      <label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå IMEI ‡∏´‡∏£‡∏∑‡∏≠ uniqueId)</label>
      <input type="file" id="csvFile" accept=".csv">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå IMEI</label>
      <select id="imeiColumn"></select>
    </div>

    <label>‡∏Å‡∏£‡∏≠‡∏Å Data Command</label>
    <input id="dataCommand" placeholder="808,100">

    <div class="actions">
      <button onclick="sendAll()">üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button onclick="exportExcel()">üì¶ Export Excel</button>
    </div>

    <h3>‚öôÔ∏è ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</h3>
    <table class="quickcmd-table">
      <thead>
        <tr><th>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</th><th>Action</th></tr>
      </thead>
      <tbody id="quickCommands"></tbody>
    </table>

    <h3>üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h3>
    <table id="resultTable">
      <thead><tr><th>IMEI</th><th>Status</th><th>Message</th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="summary" id="summaryBox"></div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà -->
    <h3>üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ö‡∏±‡∏ã‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏î‡∏±‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡πâ‡∏ß‡∏¢ GPS Command</h3>
    <table class="quickcmd-table buzzer">
      <thead>
        <tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>Action</th></tr>
      </thead>
      <tbody id="buzzerCommands"></tbody>
    </table>
  </div>

  <script>
    const API_URL = "https://vt-100-l-sendcommand.vercel.app/api/send";
    const AUTH = btoa("admin:admin123");
    let mode = "manual", parsedData = [], columns = [];
    let results = [];

    const commandList = [
      ["üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ IP / ‡∏û‡∏≠‡∏£‡πå‡∏ï", "0000,100,1,18.142.155.204,5222"],
      ["üåê ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ APN AIS", "0000,109,onelink.net"],
      ["üåê ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ APN True", "0000,109,internet"],
      ["üîÅ ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", "0000,910,3"],
      ["‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "0000,102,30,60"],
      ["‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô", "0000,123,80"],
      ["Sleep Mode 0", "0000,124,0"],
      ["Sleep Mode 1", "0000,124,1"],
      ["Sleep Mode 2", "0000,124,2"],
      ["‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Output Relay", "0000,251,1,0"],
      ["‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Output buzzer", "0000,251,1,3,0,500,500,0"],
      ["‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå", "0000,610,0"],
      ["‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GPRS/SMS", "0000,611,1"],
      ["‡∏ï‡∏±‡∏î‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå", "0000,900,1,1"],
      ["‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå", "0000,900,1,0"],
      ["üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", "800"],
      ["üî¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SN/IMEI", "801"],
      ["‚öôÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", "802"],
      ["üßæ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IP,port", "808,100"],
      ["üßæ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "808,102"]
    ];

    const buzzerList = [
      ["‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Output ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö buzzer", "251,1,3,0,500,500,0"],
      ["‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Output ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "901,1,0"],
      ["‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "210,1,1,1,3,17,18,19,20,22,23,24,27,28,32,33,36,37,38,42,43,44,45,50,51,57,58"],
      ["‡∏ï‡∏±‡πâ‡∏á Output ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå", "212,1,1,22"]
    ];

    function renderQuickCommands() {
      const tbody = document.getElementById("quickCommands");
      tbody.innerHTML = "";
      commandList.forEach(([label, cmd], i) => {
        tbody.innerHTML += `
          <tr>
            <td>${label}</td>
            <td><input class="cmd-input" id="cmd_${i}" value="${cmd}"></td>
            <td><button onclick="sendQuickCommand(${i})">üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ</button></td>
          </tr>`;
      });
    }

    function renderBuzzerCommands() {
      const tbody = document.getElementById("buzzerCommands");
      tbody.innerHTML = "";
      buzzerList.forEach(([label, cmd], i) => {
        tbody.innerHTML += `
          <tr>
            <td>${i + 1}. ${label}</td>
            <td><input class="cmd-input" id="buzzer_${i}" value="${cmd}"></td>
            <td><button onclick="sendBuzzerCommand(${i})">üöÄ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ</button></td>
          </tr>`;
      });
    }

    renderQuickCommands();
    renderBuzzerCommands();

    function setMode(m) {
      mode = m;
      document.getElementById("manualMode").classList.toggle("hidden", m !== "manual");
      document.getElementById("csvMode").classList.toggle("hidden", m !== "csv");
      document.getElementById("btnManual").classList.toggle("active", m === "manual");
      document.getElementById("btnCSV").classList.toggle("active", m === "csv");
    }

    document.getElementById("csvFile").addEventListener("change", e => {
      const file = e.target.files[0];
      Papa.parse(file, {
        header: true,
        complete: res => {
          parsedData = res.data;
          columns = res.meta.fields;
          const select = document.getElementById("imeiColumn");
          select.innerHTML = "";
          columns.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.text = c;
            select.appendChild(opt);
          });
          alert("‚úÖ ‡πÇ‡∏´‡∏•‡∏î CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + parsedData.length + " ‡πÅ‡∏ñ‡∏ß");
        }
      });
    });

    function getIMEIs() {
      if (mode === "manual") {
        return document.getElementById("manualIMEIs").value
          .split(/[\n,]+/).map(x => x.trim()).filter(Boolean);
      } else {
        const col = document.getElementById("imeiColumn").value;
        return parsedData.map(r => r[col]).filter(Boolean);
      }
    }

    async function sendQuickCommand(i) {
      const cmd = document.getElementById(`cmd_${i}`).value.trim();
      await sendAllToDevices(cmd);
    }

    async function sendBuzzerCommand(i) {
      const cmd = document.getElementById(`buzzer_${i}`).value.trim();
      await sendAllToDevices(cmd);
    }

    async function sendAllToDevices(cmd) {
      const imeiList = getIMEIs();
      if (imeiList.length === 0) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà IMEI ‡∏Å‡πà‡∏≠‡∏ô!");
      if (!cmd) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á!");
      const confirmSend = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "${cmd}" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${imeiList.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
      if (!confirmSend) return;
      document.querySelector("#resultTable tbody").innerHTML = "";
      results = [];
      for (const imei of imeiList) {
        const result = await sendCommand(imei, cmd);
        results.push(result);
        renderResult(result);
      }
      renderSummary();
      alert(`‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "${cmd}" ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (${results.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)`);
    }

    async function sendCommand(imei, data) {
      const body = { uniqueId: imei, description: "custom", type: "custom", attributes: { data } };
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Basic " + AUTH },
          body: JSON.stringify(body)
        });
        const json = await res.json();
        return { imei, status: res.ok ? "‚úÖ Success" : "‚ùå Fail", message: JSON.stringify(json, null, 2) };
      } catch (err) {
        return { imei, status: "‚ùå Error", message: err.message };
      }
    }

    function renderResult(result) {
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML += `
        <tr>
          <td>${result.imei}</td>
          <td class="${result.status.includes("Success") ? "ok" : "fail"}">${result.status}</td>
          <td><pre>${result.message}</pre></td>
        </tr>`;
    }

    function renderSummary() {
      const success = results.filter(r => r.status.includes("Success")).length;
      const fail = results.length - success;
      document.getElementById("summaryBox").innerHTML = `
        ‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
        ‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${fail} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
        ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${results.length} IMEI
      `;
    }

    async function sendAll() {
      const data = document.getElementById("dataCommand").value.trim();
      await sendAllToDevices(data);
    }

    function exportExcel() {
      if (results.length === 0) return alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export");
      const ws = XLSX.utils.json_to_sheet(results);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Results");
      XLSX.writeFile(wb, "command_results.xlsx");
    }
  </script>
</body>
</html>
